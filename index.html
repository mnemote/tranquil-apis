<html>
  <head>
    <title>Tranquil APIs</title>
    <style type="text/css">
        body { font-family: Verdana, sans; }
        h1 { text-align: center; }
        pre { border: 1px solid grey; }
    </style>
  </head>

  <body>
    <h1>Tranquil v0.1</h1>


<h2>Introduction</h2>

<p><em>Tranquil</em> is a protocol framework which helps define the communication
between web client and server.
It is designed to be very simple and very extensible.</p>

<p>Tranquil is similar in intention to
<a href="http://en.wikipedia.org/wiki/Representational_state_transfer">REST</a>,
however:</p>

<ul>
<li>Tranquil is transport agnostic.</li>
<li>Tranquil allows multiple queries per request.</li>
<li>Tranquil actions are composable and extensible.</li>
</ul>

<p>By contrast with <a href="http://json-rpc.org/">JSON-RPC</a> and
<a href="http://en.wikipedia.org/wiki/SOAPjr">SOAPjr</a>, Tranquil places more emphasis on
entities and less on methods, with the intention of reducing the
proliferation of custom methods.</p>


<h2>Requests</h2>

<p>Tranquil requests can contain multiple queries, encoded into a single
datastructure which describes what operations to perform and what data
is to be returned.</p>
<p>By standardizing the form of requests, front-end developers are able to
adjust for their own requirements and back-end developers can enforce
uniform business rules across all requests.  By encoding requests as
JSON (etc) data structures, issues of parsing and encoding queries are
eliminated.</p>


<h3>Context</h3>

<p>A <em>context</em> describes a group of resources.
For example, a context could be "all users" or "all active users"
or "all users over 35" or "all contacts for user number 12345".</p>
<p>A context is specific to a request, so context methods have access
to authentication and session information and can enforce business rules.
For example, a context for an unauthorized
user may have access to fewer resources and perform fewer actions on
those resources than the context
for an administrator user.</p>


<h3>Actions</h3>

<p><em>Actions</em> transform contexts into other contexts
<strong>OR</strong> into data which is returned in the response.
For example, the "all users" context could be transformed into
the "users over 35" context using a "filter" action.</p>

<p>Basic actions include the usual
<a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">Create, Read, Update and Delete</a>
but actions may also include more complex operations such as
<a href="http://en.wikipedia.org/wiki/MapReduce">Map, Reduce</a>
and <a href="http://en.wikipedia.org/wiki/Atomic_(computer_science)">Atomic</a>
increments, appends and so on.</p>

<p>Not all actions return a new context: some may produce
data for return to the client.</p>

<p>An action is represented as a list of an <em>action_name</em>
and some <em>parameters</em>.  Parameters can be any data type,
and there may be multiple of them.</p> 

<p><em>As a shortcut, actions without parameters can be represented
as plain strings.</em></p>

<p>Example actions:</p>

<pre>
"count"

[ "count" ]

[ "before", "2011-12-13" ]

[ "between", 7, 12 ]

[ "colors", [ "red", "green", "blue" ] ]

[ "filter", { "is_active": true } ]
</pre>


<h3>Action Lists</h3>

<p>An <em>action list</em> is a list of actions, which compose left to right.</p>

<p>Example action_lists:</p>

<pre>
[ "count" ]

[ [ "filter", { "is_author": true } ], "count" ]
</pre>

<p>In the second example, the initial context is first filtered
to make a new context, then the number of records in the context
are counted and the count is returned.</p>


<h3>Action Groups</h3>

<p>An <em>action group</em> labels actions and runs them in parallel in the
same context.
The structure is <tt>{ action_label: action_list }</tt>.</p>

<p><em>As a shortcut, if the righthand side is a plain string it is assumed
to be the name of a single action with no parameters.</em></p>

<p>However, if the righthand side is a list it <strong>MUST</strong> be an action list,
not an individual action.  A single action must be wrapped into an
action list to avoid syntactic confusion:</p>

<pre>
{
    "count": "count",
    "page": [ [ "page", 0, 5 ] ]
}
</pre>

<p>The <em>action labels</em> are a convenience to the frontend programmer:
they are used to construct a response.  For example, the above
query returns something like:</p>

<pre>
{
     "count": 107,
     "page": [ {...}, {...}, {...}, {...}, {...} ]
}
</pre>

<p>... this is done for readability and so so that you can
conveniently refer to <tt>response.count</tt> and <tt>response.page[n]</tt>
from javascript.</p>


<h4>Nesting Action Groups</h4>

<p>Action groups nest:</p>

<pre>
{
    "authors": [
        "users",
        [ "filter": { "is_author": true } ],
        {
            "count": "count",
            "top10": [
                [ "sort", "-score" ],
                [ "page", 0, 10 ]
            ]
        }
    ]
}
</pre>

<p>will return <tt>authors.count</tt> and <tt>authors.top10</tt>.</p>


<h4>Composing Action Groups</h4>

<p>Composable action groups:</p>

<pre>
{
    "authors": [
        "users",
        [ "filter": { "is_author": true } ],
        {
            "male": [ "filter", { "gender": "M" } ],
            "female": [ "filter", { "gender": "F" } ]
        },
        {
            "count": "count",
            "top10": [
                [ "sort", "-score" ],
                [ "page", 0, 10 ]
            ]
        }
    ]
}
</pre>

<p>... will assess the third action group for each of the actions
in the second action group and thus return
<tt>authors.male.count</tt> and <tt>authors.female.count</tt> and
<tt>authors.male.top10</tt> and <tt>authors.female.top10</tt>.</p>

<p><em>This may not prove to be all that useful and implementations may
choose to not support it.</em></p>


<h3>Writing with Actions</h3>

<p>The examples above are all read-only actions.  Actions may also
mutate database state.  Operations apply to all resources in the
current context:</p>

<pre>
[
    "users",
    [ "filter": { "age": [ "gt", "40" ] } ],
    [ "update": { "trust": false } ]
]
</pre>

<p>Mutating actions aren't limited to Create, Update and Delete.
For example, actions could be defined for Increment, Append,
Shuffle, Swap.  Mutating actions can also return data, allowing
for safe appends and increments and so on.</p>


<h3>Transactions</h3>

<p>Where possible, the whole query should be handled in a single
database transaction, which should be rolled back if any part fails.  As
a Tranquil API can run on non-Transactional stores, or across
multiple stores, this may not always be possible.</p>

<p>Where nested transactions are available, each action list which
contains a mutating action should have its own transaction, so
that the results of the mutation are visible from subsequent actions
in that action list but not from other action lists.</p>

<h2>Transport &amp; Encoding</h2>

<p>Tranquil is transport- and encoding-agnostic.</p>


<h3>HTTP POST and JSON</h3>

<p>Typically, requests are encoded as JSON and transported in the body of
HTTP POST requests:</p>

<pre>
POST /api
Content-Type: application/json
Accept: application/json

{ "user_count": [ "users", "count" ] }
</pre>
<p>The request body is interpreted as a JSON data structure and treated
as an action list if an array or as an action group if an object.</p>

<p>The HTTP response also contains JSON:</p>

<pre>
200 OK
Content-Type: application/json

{ "user_count": 107 }
</pre>

<p>In the case of JSON or Tranquil syntax errors, HTTP status
<tt>400 Bad Request</tt> is returned.  Other error codes may be returned
for other issues.</p>

<p>A single URL endpoint is used for all contexts.  Keeping the message
details out of the URL simplifies request encoding.</p>

<h4>Using from vanilla javascript</h4>

<p>A very simple example which doesn't need any external libraries or
frameworks (but has no error handling):</p>

<pre>
function tranquil_request(url, request, callback) {
    var xhr = new XMLHttpRequest();
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('Accept', 'application/json');
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            var response = JSON.parse(xhr.response);
            callback(response);
        }
    };
    xhr.open('POST', url, true);
    xhr.send(JSON.stringify(request));
}

tranquil_request(
    '/api',
    { user_count: [ "users", "count" ] },
    function (response) { alert(response.user_count); }
);
</pre>


<h4>Using from jQuery</h4>

<p>Using <a href="http://api.jquery.com/jQuery.ajax/">jQuery's AJAX function</a>:</p>

<pre>
var request = {
    user_count: [ "users", "count" ]
};

$.ajax({
    type: "POST",
    url: "/api",
    processData: false,
    contentType: "application/json",
    dataType: "json",
    data: JSON.stringify(request)
}).done(function (response, jqxhr) {
    alert(jqxhr.responseJSON.user_count);
});
</pre>

<h3>Other Encodings</h3>

<p>The above examples are all in JSON, but
<a href="https://code.google.com/p/protobuf/">ProtoBuf</a> /
<a href="http://www.w3.org/XML/">XML</a> /
<a href="http://en.wikipedia.org/wiki/Abstract_Syntax_Notation_One">ASN1</a> /
<a href="http://rosettacode.org/wiki/S-Expressions">S-expression</a>
encodings would be easy to define
if there was a need to do so.</p>

<p>Implementations using HTTP transport
should use the HTTP <tt>Content-Type</tt> and <tt>Accept</tt> headers to decide
which encoding is appropriate for requests and responses.</p>

<h3>Other Transports</h3>

<p>Tranquil is transport-agnostic, so transport could be by
<a href="http://websocket.org/">WebSockets</a>, <a href="http://amqp.org/">AMQP</a>
or <a href="http://www.ietf.org/rfc/rfc1149.txt">avian carrier</a>.</p>

<p>The same resources can be made available over multiple transports
and encodings to allow for access from multiple platforms or for
backwards compatibility.</p>

<h2>Implementation</h2>

<p>Reference implementations are in progress ... see
<a href="https://github.com/nickzoic/tranquil/">Tranquil on Github</a></p>

<p>They are not very advanced yet and contributions for these and
other platforms are welcomed!</p>

<h2>Intellectual Property</h2>

<p>At present, this document is &copy; 2014 Mnemote Pty Ltd, and all rights are reserved.</p>

<p>The intention going forward is to standardize Tranquil APIs through an appropriate working group
and then assign the IP to the Internet Society or equivalent.</p>
  </body>
</html>
